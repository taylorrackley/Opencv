<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabinet Door Detection</title>
    <style>
        body { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 10px; 
        }
        #container { 
            position: relative; 
            display: inline-block; 
            margin-top: 20px;
        }
        #image { 
            max-width: 100%; 
            display: block; 
        }
        .door-div { 
            position: absolute; 
            background-color: rgba(0, 255, 0, 0.3); 
            border: 2px solid green; 
            box-sizing: border-box; 
        }
        .drawer-div {
            position: absolute;
            background-color: rgba(255, 165, 0, 0.3);
            border: 2px solid orange;
            box-sizing: border-box;
        }
        #output { 
            margin-top: 15px; 
            font-size: 18px; 
            font-weight: bold;
        }
        #config { 
            margin: 15px 0; 
            width: 100%; 
            max-width: 500px; 
            padding: 15px; 
            border: 1px solid #ccc; 
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        #config h3 {
            margin-top: 0;
            color: #333;
        }
        #config label { 
            display: block; 
            margin: 8px 0; 
        }
        #config input[type="range"] { 
            width: 100%; 
        }
        #config input[type="checkbox"] { 
            margin-right: 5px; 
        }
        .config-row {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }
        .config-column {
            flex: 1;
        }
        #actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #45a049;
        }
        #reset {
            background-color: #f44336;
        }
        #reset:hover {
            background-color: #d32f2f;
        }
        .detection-summary {
            margin-top: 15px;
            padding: 10px;
            background-color: #e8f5e9;
            border-radius: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>Cabinet Door Detection</h1>
    <input type="file" id="imageInput" accept="image/*">
    
    <div id="config">
        <h3>Detection Parameters</h3>
        <div class="config-row">
            <div class="config-column">
                <label>Blur Size: <span id="blurSizeValue">5</span>
                    <input type="range" id="blurSize" min="1" max="21" step="2" value="5">
                </label>
                <label>Canny Low: <span id="cannyLowValue">20</span>
                    <input type="range" id="cannyLow" min="10" max="200" value="20">
                </label>
                <label>Canny High: <span id="cannyHighValue">50</span>
                    <input type="range" id="cannyHigh" min="30" max="300" value="50">
                </label>
                <label>
                    <input type="checkbox" id="useAdaptiveThreshold" checked> Use Adaptive Threshold
                </label>
            </div>
            <div class="config-column">
                <label>Min Door Width: <span id="minDoorWidthValue">100</span>
                    <input type="range" id="minDoorWidth" min="50" max="300" value="100">
                </label>
                <label>Min Door Height: <span id="minDoorHeightValue">150</span>
                    <input type="range" id="minDoorHeight" min="50" max="400" value="150">
                </label>
                <label>Max Door Width: <span id="maxDoorWidthValue">400</span>
                    <input type="range" id="maxDoorWidth" min="100" max="800" value="400">
                </label>
                <label>Max Door Height: <span id="maxDoorHeightValue">600</span>
                    <input type="range" id="maxDoorHeight" min="100" max="800" value="600">
                </label>
            </div>
        </div>

        <div class="config-row">
            <div class="config-column">
                <label>Min Drawer Height: <span id="minDrawerHeightValue">30</span>
                    <input type="range" id="minDrawerHeight" min="10" max="150" value="30">
                </label>
                <label>Max Drawer Height: <span id="maxDrawerHeightValue">100</span>
                    <input type="range" id="maxDrawerHeight" min="50" max="200" value="100">
                </label>
            </div>
            <div class="config-column">
                <label>Door Area Ratio: <span id="doorAreaRatioValue">0.7</span>
                    <input type="range" id="doorAreaRatio" min="0.1" max="1" step="0.05" value="0.7">
                </label>
                <label>
                    <input type="checkbox" id="filterNoise" checked> Filter Noise
                </label>
                <label>
                    <input type="checkbox" id="showPreprocessed"> Show Preprocessed Image
                </label>
            </div>
        </div>

        <div id="actions">
            <button id="recalculate">Recalculate</button>
            <button id="reset">Reset Parameters</button>
        </div>
    </div>

    <div id="container">
        <img id="image" src="" alt="Uploaded Image">
        <canvas id="preprocessedCanvas" style="display: none;"></canvas>
    </div>
    
    <div id="output"></div>
    <div class="detection-summary" id="detectionSummary"></div>

    <script type="text/javascript">
        let doorsDetected = [];
        let drawersDetected = [];
        let currentImage = null;
        let config = {
            blurSize: 5,
            cannyLow: 20,
            cannyHigh: 50,
            useAdaptiveThreshold: true,
            minDoorWidth: 100,
            minDoorHeight: 150,
            maxDoorWidth: 400, 
            maxDoorHeight: 600,
            minDrawerHeight: 30,
            maxDrawerHeight: 100,
            doorAreaRatio: 0.7,
            filterNoise: true,
            showPreprocessed: false
        };

        const defaultConfig = {...config};

        function onOpenCvReady() {
            console.log('OpenCV.js is ready');
            if (typeof cv === 'undefined') {
                console.error('OpenCV.js failed to load');
                document.getElementById('output').innerText = 'Error: OpenCV.js not loaded';
                return;
            }
            
            document.getElementById('imageInput').addEventListener('change', handleImageUpload);

            // Set up event listeners for all config inputs
            Object.keys(config).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.addEventListener('change', (e) => {
                            config[key] = e.target.checked;
                        });
                    } else if (element.type === 'range') {
                        element.addEventListener('input', (e) => {
                            config[key] = parseFloat(e.target.value);
                            document.getElementById(`${key}Value`).textContent = e.target.value;
                        });
                    }
                }
            });

            // Recalculate button
            document.getElementById('recalculate').addEventListener('click', () => {
                if (currentImage) processImage(currentImage);
            });

            // Reset button
            document.getElementById('reset').addEventListener('click', () => {
                // Reset to default values
                Object.keys(defaultConfig).forEach(key => {
                    config[key] = defaultConfig[key];
                    const element = document.getElementById(key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = defaultConfig[key];
                        } else if (element.type === 'range') {
                            element.value = defaultConfig[key];
                            document.getElementById(`${key}Value`).textContent = defaultConfig[key];
                        }
                    }
                });
                if (currentImage) processImage(currentImage);
            });

            // Show preprocessed image toggle
            document.getElementById('showPreprocessed').addEventListener('change', (e) => {
                config.showPreprocessed = e.target.checked;
                document.getElementById('preprocessedCanvas').style.display = 
                    config.showPreprocessed ? 'block' : 'none';
                document.getElementById('image').style.display = 
                    config.showPreprocessed ? 'none' : 'block';
            });
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const imgElement = document.getElementById('image');
            imgElement.src = URL.createObjectURL(file);
            
            imgElement.onload = () => {
                currentImage = imgElement;
                processImage(imgElement);
            };
        }

        function processImage(imgElement) {
            const container = document.getElementById('container');
            container.style.width = imgElement.width + 'px';
            container.style.height = imgElement.height + 'px';

            // Clear previous divs
            Array.from(container.getElementsByClassName('door-div'))
                .concat(Array.from(container.getElementsByClassName('drawer-div')))
                .forEach(el => el.remove());

            // Create src Mat from image
            let src = cv.imread(imgElement);
            let gray = new cv.Mat();
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
            
            // Apply preprocessing
            let processed = preprocessImage(gray);
            
            // Display preprocessed image if needed
            if (config.showPreprocessed) {
                const canvas = document.getElementById('preprocessedCanvas');
                canvas.width = imgElement.width;
                canvas.height = imgElement.height;
                cv.imshow(canvas, processed);
            }
            
            // Find contours
            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();
            cv.findContours(processed, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
            
            // Process contours to find doors and drawers
            doorsDetected = [];
            drawersDetected = [];
            
            for (let i = 0; i < contours.size(); i++) {
                let contour = contours.get(i);
                
                // Filter out small contours as noise
                if (config.filterNoise && cv.contourArea(contour) < 500) continue;
                
                let rect = cv.boundingRect(contour);
                
                // Scale coordinates to image dimensions
                const scaleX = imgElement.width / src.cols;
                const scaleY = imgElement.height / src.rows;
                
                const scaledRect = {
                    x: rect.x * scaleX,
                    y: rect.y * scaleY,
                    width: rect.width * scaleX,
                    height: rect.height * scaleY
                };
                
                // Determine if rectangle is a door or drawer
                if (isDoor(rect)) {
                    doorsDetected.push(scaledRect);
                    createDetectionDiv(container, scaledRect, 'door-div');
                } else if (isDrawer(rect)) {
                    drawersDetected.push(scaledRect);
                    createDetectionDiv(container, scaledRect, 'drawer-div');
                }
            }

            // Update results display
            updateResults();
            
            // Cleanup
            src.delete();
            gray.delete();
            processed.delete();
            contours.delete();
            hierarchy.delete();
        }
        
        function preprocessImage(gray) {
            // Create copy to work with
            let processed = gray.clone();
            
            // Apply Gaussian blur to reduce noise
            let blurred = new cv.Mat();
            let ksize = new cv.Size(config.blurSize, config.blurSize);
            cv.GaussianBlur(processed, blurred, ksize, 0);
            
            // Apply adaptive threshold if enabled
            if (config.useAdaptiveThreshold) {
                let binary = new cv.Mat();
                cv.adaptiveThreshold(
                    blurred, 
                    binary, 
                    255, 
                    cv.ADAPTIVE_THRESH_GAUSSIAN_C, 
                    cv.THRESH_BINARY_INV, 
                    11, 
                    2
                );
                blurred.delete();
                blurred = binary;
            }
            
            // Apply Canny edge detection
            let edges = new cv.Mat();
            cv.Canny(blurred, edges, config.cannyLow, config.cannyHigh);
            
            // Dilate the edges to connect them
            let kernel = cv.Mat.ones(3, 3, cv.CV_8U);
            let dilated = new cv.Mat();
            cv.dilate(edges, dilated, kernel, new cv.Point(-1, -1), 2);
            
            // Cleanup
            processed.delete();
            blurred.delete();
            edges.delete();
            kernel.delete();
            
            return dilated;
        }
        
        function isDoor(rect) {
            const aspectRatio = rect.width / rect.height;
            
            // Check if it matches door criteria
            return (
                rect.width >= config.minDoorWidth && 
                rect.width <= config.maxDoorWidth &&
                rect.height >= config.minDoorHeight && 
                rect.height <= config.maxDoorHeight &&
                aspectRatio >= 0.3 && 
                aspectRatio <= 0.8
            );
        }
        
        function isDrawer(rect) {
            const aspectRatio = rect.width / rect.height;
            
            // Check if it matches drawer criteria
            return (
                rect.height >= config.minDrawerHeight && 
                rect.height <= config.maxDrawerHeight &&
                aspectRatio >= 1.5 && 
                aspectRatio <= 5
            );
        }
        
        function createDetectionDiv(container, rect, className) {
            const div = document.createElement('div');
            div.className = className;
            div.style.left = rect.x + 'px';
            div.style.top = rect.y + 'px';
            div.style.width = rect.width + 'px';
            div.style.height = rect.height + 'px';
            container.appendChild(div);
        }
        
        function updateResults() {
            const output = document.getElementById('output');
            output.innerText = `Detected: ${doorsDetected.length} doors and ${drawersDetected.length} drawers`;
            
            // Update detection summary
            const summary = document.getElementById('detectionSummary');
            summary.innerHTML = `
                <strong>Detection Results:</strong><br>
                - Doors: ${doorsDetected.length} (green)<br>
                - Drawers: ${drawersDetected.length} (orange)<br>
                <br>
                <strong>Tip:</strong> If detection is not accurate, try:
                <ul>
                    <li>Adjusting Canny thresholds for better edge detection</li>
                    <li>Increasing blur size if there's noise in the image</li>
                    <li>Adjusting door/drawer size parameters</li>
                </ul>
            `;
        }
    </script>

    <script src="https://docs.opencv.org/4.5.5/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
</body>
</html>
